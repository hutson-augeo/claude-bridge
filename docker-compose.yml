services:
  claude-bridge:
    build: .
    ports:
      - "3333:3333"   # HTTP API
      - "3334:3334"   # WebSocket
    volumes:
      # config.json: copy config.example.json → config.json, set host to 0.0.0.0
      - ./config.json:/app/config.json:ro
      # plugins: drop .js plugin files here; they load on startup
      - ./plugins:/app/plugins:ro
      # data: persists auth tokens across container restarts
      - bridge-data:/app/data
    environment:
      NODE_ENV: production
    restart: unless-stopped

  # ── Azure setup service ──────────────────────────────────────────────────────
  # Run once to register the Azure app and write credentials into config.json.
  # Usage: docker compose --profile setup run --rm setup
  setup:
    build:
      context: .
      target: setup
    volumes:
      # config.json: writable so the script can write clientId/tenantId
      - ./config.json:/app/config.json
      # persist Azure CLI login between setup runs (avoids re-authenticating)
      - azure-setup-creds:/root/.azure
    stdin_open: true   # keep stdin open for interactive prompts
    tty: true          # allocate a TTY for readline/device-code output
    profiles:
      - setup

volumes:
  bridge-data:
  azure-setup-creds:
